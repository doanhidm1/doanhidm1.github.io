# サブルーチンとは

サブルーチンとは、いくつかの処理のをまとめた物で、ほかの箇所から「呼び出して」つかう物です。サブルーチンの処理が終わると、呼び出した所へ制御が戻ります。

　マクロ  ( → [マクロを使おう](Macro) )  と機能は似ていますが、サブルーチンの方がより本格的な処理を行うのに対し、マクロは簡単な処理を行う用途です。

# サブルーチンの基本的な使い方

サブルーチンはラベルによって区別されますので、ラベルを定義します。サブルーチンから呼び出し元に戻るところに return タグ、サブルーチンを呼び出すには call タグを用います。
　下の例を見てください。

`[wait time=200]
*start|スタート
[cm]
サブルーチンを呼び出します。[l][r]
[call target=*subroutine]
サブルーチンを呼び出しました。
[s]

*subroutine
これはサブルーチンです。[l][r]
クリックをすると呼び出し元に戻ります。[l][r]
[return]`

　さて、この例を実行させると、「サブルーチンを呼び出します。」のメッセージのあとに「これはサブルーチンです。」と表示され、「クリックをすると呼び出し元に戻ります。」でクリックすると、「サブルーチンを呼び出しました。」と表示されるはずです。
　つまり、call タグで指定したラベルにジャンプをするのですが、このときに呼び出した位置が自動的に記録され、return タグでは、この記録された呼び出し元に自動的に戻ります ( この自動的に記録されるものを「コールスタック」と呼んでいます )。
　この例では、`*subroutine` から `[return]` までが「サブルーチン」です。

　サブルーチンの中からほかのサブルーチンを呼び出すこともできます。呼び出しの深さ ( return せずにいくつまで call できるか ) に制限はありません。

　ちなみに「選択肢を使ってみよう」の所ではラベルの次には [cm] を書くと書きましたが、セーブの箇所となるような ( | 付きの ) ラベルの次でなければ [cm] を書かなくても OK です。

　コールスタックには、シナリオファイル名、シナリオ中の直前のラベルとそれから call タグのある行までの行数、call タグのある行の内容、その行内での位置の情報しか記録されません。シナリオのデバッグ中などで、戻り先のシナリオファイル中の構成が変わるととんでもない位置に戻ってしまう場合があるので注意してください。
　基本的には、サブルーチンのラベルやサブルーチン中には、セーブ箇所となるラベル ( | 付きのラベル ) を使わない/作らないが吉です。

# サブルーチンに関する注意

call で自分自身を呼びだしてしまったりすると無限ループにはまります。
　call と return の対応がとれていないと、どんどんコールスタックが増えていったり、あるいは return タグのところで呼び出し元に戻れなくなってエラーになる事がありますので、注意してください。

　それと、次の例のように

`*subroutine
・・・
[if exp="f.flag1"][jump target=*otherplaces1][endif]
[if exp="f.flag2"][jump target=*otherplaces2][endif]
・・・
[return]

*otherplaces1
・・・
[return]

*otherplaces2
;この先には return タグがない・・・`

　サブルーチン中で他の場所にジャンプする場合は注意してください。otherplaces1 にジャンプする場合は、ジャンプ先に return があるので call ～ return のバランスを崩すことはありません。しかし、otherplaces2 にジャンプする場合、ジャンプした先に return が現れないので、そのサブルーチンからは「戻ってない」ことになります。つまり、call ～ return のバランスを崩してしまいます。

　もし、呼び出し元に戻るのではなく、任意の場所に戻りたい場合は、return タグの storage や target 属性を利用して、任意の場所に戻ることができます。